<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../user-message/user-message.html">

<dom-module id="chat-bot">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-card{
        height: 550px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        margin: 30px;
      }
      paper-button{
        background-color: var(--paper-green-500);
        color: white;
        margin-bottom: 2px;
        border: transparent;
        border-radius: 5px;
        font-size: 16px;
        padding: 5px;
        width: 100px;
        height: 50px;
        text-align: center;
      }
      header{
        background-color: #0288D1;
        color: white;
        padding-left: 30px;
      }
      div#chat{
        overflow: auto;
        height: 100%;
        max-height: 400px;
      }
      user-message{
        padding: 5px;
      }

      div.buttons{
        display: flex;
        justify-content: space-around;
      }
    </style>

    <paper-card>
      <header>
        <h1>I'm a bot</h1>
      </header>
      <div id="chat">
        <dom-repeat items="[[messages]]" as="message">
          <template>
            <user-message id="message" text="[[message.question]]" from="[[message.from]]"></user-message>
          </template>
        </dom-repeat>
      </div>
      <div class="buttons">
        <dom-repeat items="[[buttons]]" as="button">
          <template>
            <paper-button data-opcion="[[button]]" id="[[button]]" on-tap="getOptionSetected">[[button]]</paper-button>
          </template>
        </dom-repeat>
      </div>
    </paper-card>
  </template>

  <script>
    class ChatBot extends Polymer.Element {
    static get is() { return 'chat-bot'; }
    static get properties() {
      return {
        nodes: {
          type: Array,
          value: [],
          computed: '_loadNodes()'
        },
        messages: {
          type: Array,
          value: [],
          observer: '_goToBottom'
        },
        buttons: {
          type: Array,
          value:[]
        },
        currentNode: {
          type:Array,
          value: []
        }, 
        input: {
          type: String,
          value: ''
        }
      };
    }

    ready(){
      super.ready()

      this.set('currentNode', bienvenida1);
      this.printMessage(this.currentNode);
      this.printButtons(this.currentNode);

    }

    printMessage(node){
      const messages = this.messages;
      const message = [{
        question: node.question,
        from: node.from
      }]
      this.messages = [... messages, ...message];
    }

    userMessage(data){
      const messages = this.messages;
      const message = [data];
      this.messages = [...messages, ...message];
    }

    printButtons(node){
      let buttons = [];
      for(let key of node.options.keys()){
        buttons.push(key)
      }
      this.set('buttons', buttons);
    }

    getOptionSetected(event){
      const optionSelected = event.model.__data.button;
      const message = {
        question: optionSelected,
        from: 'user'
      }
      this.userMessage(message)
      this.getNodeToProced(optionSelected);
    }

    getNodeToProced(option){
      const netxNode = this.currentNode.options.get(option);
      this.printMessage(netxNode);
      this.printButtons(netxNode);
      this.set('currentNode', netxNode);
    }

    _goToBottom(){
      const div = this.shadowRoot.querySelector('#chat');
      div.scrollTop = div.scrollHeight;
    }
  }

  window.customElements.define(ChatBot.is, ChatBot);
  </script>
</dom-module>
