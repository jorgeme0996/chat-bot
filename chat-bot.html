<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../user-message/user-message.html">
<script src="./models/Node.js"></script>

<dom-module id="chat-bot">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-card{
        height: 550px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        margin: 30px;
      }
      button{
        background-color: var(--button-background-color, #43A047);
        color: var(--button-letter-color, white);
        text-align: center;
        margin-bottom: 2px;
        border: transparent;
        border-radius: 5px;
        font-size: 16px;
        padding: 5px;
        width: 150px;
        height: 50px;
        text-transform: uppercase;
        @apply --button-styles
      }
      button:hover {
        transform: scale(1.1);
        cursor: pointer;
      }
      header{
        padding-left: 30px;
        color: var(--header-letter-color, white);
        background-color: var(--background-header, #00897B);
        @apply --header-styles
      }
      div#chat{
        overflow: auto;
        height: 100%;
        max-height: 400px;
        background-color: var(--background-chat-color, white);
        @apply --chat-container-style;
      }
      user-message{
        padding: 5px;
      }
      div.buttons{
        display: flex;
        justify-content: space-around;
        margin-top: 2%;
      }
    </style>

    <paper-card>
      <header>
        <h1>I'm a bot</h1>
      </header>
      <div id="chat">
        <dom-repeat items="[[messages]]" as="message">
          <template>
            <user-message id="message" text="[[message.question]]" from="[[message.from]]"></user-message>
          </template>
        </dom-repeat>
      </div>
      <div class="buttons">
        <dom-repeat items="[[buttons]]" as="button">
          <template>
            <button data-opcion="[[button]]" id="[[button]]" on-click="getOptionSetected">[[button]]</button>
          </template>
        </dom-repeat>
      </div>
    </paper-card>
  </template>

  <script>
    class ChatBot extends Polymer.Element {
    static get is() { return 'chat-bot'; }
    static get properties() {
      return {
        nodes: {
          type: Array,
          value: [],
          observer: '_setInitialNode'
        },
        messages: {
          type: Array,
          value: []
        },
        buttons: {
          type: Array,
          value:[]
        },
        currentNode: {
          type: Node,
          value: new Polymer.Node
        }, 
        initialNode: {
          type: Array,
          value: []
        }
      };
    }

    ready(){
      super.ready();
      this.printMessage(this.currentNode);
      this.printButtons(this.currentNode);
    }

    _setInitialNode(){
      const initialNode = this.nodes[0];
      this.set('currentNode', initialNode);
    }

    printMessage(node){
      const messages = this.messages;
      const message = [{
        question: node.question,
        from: node.from
      }]
      this.messages = [... messages, ...message];
    }

    userMessage(data){
      const messages = this.messages;
      const message = [data];
      this.messages = [...messages, ...message];
    }

    printButtons(node){
      let buttons = [];
      for(let key of node.options.keys()){
        buttons.push(key)
      }
      this.set('buttons', buttons);
    }

    getOptionSetected(event){
      const optionSelected = event.model.__data.button;
      const message = {
        question: optionSelected,
        from: 'user'
      }
      this.userMessage(message)
      this.getNodeToProced(optionSelected);
    }

    getNodeToProced(option){
      const netxNode = this.currentNode.options.get(option);
      this.printMessage(netxNode);
      this.printButtons(netxNode);
      this.set('currentNode', netxNode);
    }
  }

  window.customElements.define(ChatBot.is, ChatBot);
  </script>
</dom-module>